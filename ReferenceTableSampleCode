-- Find all the children of an ingredient - this example is acetaminephen
select distinct ancestor_desc, ancestor_concept_cd, ancestor_level from tc_act_med_alpha_v41 where ancestor_level = 7 order by ancestor_desc; -- list ingredients
select ancestor_desc, ancestor_concept_cd, desc_concept_cd, descendant_desc from tc_act_med_alpha_v41 
where ancestor_concept_cd = 'RXNORM:161' and desc_concept_cd like 'RXNORM:%'
order by descendant_desc; 

--Count concepts by terminology type in a reference table - This example NDCs in medications
--(NDC:, RXNORM:, ICD10CM:, ICD9CM:, ICD10PCS:, ICD9PROC:, LOINC:, CPT4:, HCPCS:, CVX:)
select count(*) from tc_act_med_alpha_v41 where ancestor_level = 10 and ancestor_concept_cd like 'NDC:%'; --972000 all NDC

--diagnosis
-- find (string search) a diagnosis
--asthma
select distinct ancestor_desc, ancestor_concept_cd
from tc_act_icd10cm_dx_v41
where lower(ancestor_desc) like '%asthma%' 
order by ancestor_desc; 

-- find all children of J45 Asthma
select ancestor_desc, ancestor_concept_cd, desc_concept_cd, descendant_desc 
from tc_act_icd10cm_dx_v41
where ancestor_concept_cd = 'ICD10CM:J45' 
order by descendant_desc;

-- find all children of C50 Breast Cancer
select ancestor_desc, ancestor_concept_cd, desc_concept_cd, descendant_desc 
from tc_act_icd10cm_dx_v41
where ancestor_concept_cd = 'ICD10CM:C50' 
order by descendant_desc; 

-- find all parents of breast cancer
select  ancestor_desc, ancestor_concept_cd, desc_concept_cd, descendant_desc
from tc_act_icd10cm_dx_v41
where desc_concept_cd = 'ICD10CM:C50' 
order by ancestor_path;

-- find all parents of lab LOINC:49909-5 interleukin
select  ancestor_desc, ancestor_concept_cd, desc_concept_cd, descendant_desc
from tc_act_loinc_lab_prov_v41
where desc_concept_cd = 'LOINC:49909-5' 
order by ancestor_path;


-- find all parents of lab LOINC:4548-4 Hemoglobin A1C
select  ancestor_desc, ancestor_concept_cd, desc_concept_cd, descendant_desc
from tc_act_loinc_lab_prov_v41
where desc_concept_cd = 'LOINC:4548-4' 
order by ancestor_path;

--find all HbA1C measures LOINC:LP16413-4 using the parent of a specific loinc from the previous query
select ancestor_desc, ancestor_concept_cd, desc_concept_cd, descendant_desc 
from tc_act_loinc_lab_prov_v41
where ancestor_concept_cd = 'LOINC:LP16413-4' 
order by descendant_path;

-- find all parents of medication ingredient semaglutide
select  ancestor_desc,  ancestor_concept_cd, desc_concept_cd, descendant_desc, ancestor_path
from tc_act_med_va_v41
where desc_concept_cd = 'RXNORM:1991302' 
order by ancestor_path;

-- find all children of medication class Hypoglycemic Agents,Other (HS509)
select  ancestor_desc,  ancestor_concept_cd, desc_concept_cd, descendant_desc, descendant_path
from tc_act_med_va_v41
where ancestor_concept_cd = 'VANDF:HS509' 
order by descendant_path;


-- find first level children of medication class Hypoglycemic Agents,Other (HS509) - in this case the first level would be ingredients
-- if you are higher up in the classification tree the first level children may be other classifications
select  ancestor_desc,  ancestor_concept_cd, desc_concept_cd, descendant_desc, descendant_path, REGEXP_COUNT(descendant_path, '\\') as c_hlevel
from tc_act_med_va_v41
where ancestor_concept_cd = 'VANDF:HS509' and REGEXP_COUNT(descendant_path, '\\') = 10
order by descendant_path;

--find the ingredients
select distinct ancestor_desc, ancestor_concept_cd,  REGEXP_COUNT(ancestor_path, '\\')
from tc_act_med_alpha_v41
where  (lower(ancestor_desc) like 'benralizumab%'
    or lower(ancestor_desc) like 'dupilumab%'
    or lower(ancestor_desc) like 'omalizumab %'
    or lower(ancestor_desc) like 'reslizumab %'
    or lower(ancestor_desc) like 'mepolizumab %'
    or lower(ancestor_desc) like 'tezepelumab %'
    )
    and REGEXP_COUNT(ancestor_path, '\\') = 8 -- ingredient levelin the medication_alpha ontology
order by ancestor_desc;

--find all the children of the ingredient including RXNORM, NDC and HCPCS (using the codes from the find the ingredients query)
select  ancestor_desc,  ancestor_concept_cd, desc_concept_cd, descendant_desc, descendant_path
from tc_act_med_alpha_v41
where ancestor_concept_cd in  ('RXNORM:1989100','RXNORM:1876376', 'RXNORM:1720597','RXNORM:302379','RXNORM:1746889','RXNORM:2587789')
order by descendant_path;
